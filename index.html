<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kuis Perilaku Anak Hebat</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --bg-container: #ffffff;
            --primary: #6FB1FC;      
            --success: #6AC445;
            --danger: #FF525F;
            --warning: #FF9800;
            --text-dark: #333;
            --shadow-soft: 0 8px 24px rgba(149, 157, 165, 0.2);
            --radius-box: 25px;
            --box-bottom-edge: #B3D7FF; 
            
            --card-width: 260px; 
            --card-height: 350px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* --- ANIMASI --- */
        @keyframes colorCycle {
            0%   { background-color: #FFD1D1; } 25%  { background-color: #FFFAD1; } 
            50%  { background-color: #D1FFD6; } 75%  { background-color: #D1E8FF; } 
            100% { background-color: #FFD1D1; } 
        }

        @keyframes borderFlow {
            0%   { border-bottom-color: #FF0055; } 
            25%  { border-bottom-color: #FFCC00; } 
            50%  { border-bottom-color: #00DD55; } 
            75%  { border-bottom-color: #0088FF; } 
            100% { border-bottom-color: #FF0055; } 
        }

        @keyframes popUp {
            0% { opacity: 0; transform: scale(0.5); }
            70% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes pulseBtn {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 82, 95, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 82, 95, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 82, 95, 0); }
        }

        @keyframes arrowPointUp {
            from { transform: translateY(0); opacity: 0.8; }
            to { transform: translateY(-20px); opacity: 1; }
        }

        @keyframes swipeRightAnim {
            0% { transform: translate(0, 0); opacity: 0; } 20% { opacity: 1; }
            80% { transform: translate(150px, 20px) rotate(10deg); opacity: 0; } 100% { transform: translate(0, 0); opacity: 0; }
        }
        @keyframes swipeLeftAnim {
            0% { transform: translate(0, 0); opacity: 0; } 20% { opacity: 1; }
            80% { transform: translate(-150px, 20px) rotate(-10deg); opacity: 0; } 100% { transform: translate(0, 0); opacity: 0; }
        }

        @keyframes countPop {
            0% { transform: scale(0.5); opacity: 0; } 20% { transform: scale(1.2); opacity: 1; }
            80% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } 
        }

        @keyframes pulseLogo { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .pop-in {
            opacity: 0;
            animation: 
                popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, 
                borderFlow 5s linear infinite;
        }

        .delay-1 { animation-delay: 0.1s, 0s; } 

        .tutorial-arrow {
            position: absolute; top: 60px; right: 5px; font-size: 4rem; color: #FFD700; text-shadow: 2px 2px 0 #000; z-index: 6000; pointer-events: none; animation: arrowPointUp 0.6s ease-in-out infinite alternate;
        }

        .highlight-focus {
            position: relative; z-index: 9999 !important;
            animation: pulseBtn 1.5s infinite !important;
            background: #fff !important; border: 3px solid var(--danger) !important;
        }

        /* --- OVERLAY GELAP FIXED (MENYELURUH) --- */
        #tut-guide-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000; 
            display: none; pointer-events: none; 
        }
        
        #tut-hand {
            position: absolute; font-size: 6rem; text-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 6000; display: none; pointer-events: none;
            top: 50%; left: 50%; margin-top: -3rem; margin-left: -3rem;
            filter: drop-shadow(0 0 10px white);
        }

        /* --- SOLUSI KARTU TERANG (LIFTING Z-INDEX) --- */
        /* Class ini mengangkat container kartu ke atas overlay gelap (FIX GELAP) */
        .lift-z-index {
            z-index: 4000 !important;
            position: relative;
        }
        
        .highlight-card {
            position: relative; z-index: 5000 !important; 
            border-radius: 20px; 
            box-shadow: 0 0 50px 30px rgba(255,255,255,0.2) !important; 
        }

        .allow-overflow { overflow: visible !important; z-index: 3500 !important; }

        body {
            margin: 0; padding: 0; font-family: 'Fredoka One', cursive; animation: colorCycle 40s linear infinite; height: 100vh; overflow: hidden; color: var(--text-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 0; transition: background-color 0.1s linear; 
        }

        #background-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: -1; }
        .floating-emoji { position: absolute; font-size: 40px; opacity: 0.15; filter: grayscale(100%); user-select: none; will-change: transform; }

        /* STYLE KOTAK */
        .container-box, .game-header, .game-body, .home-container { background-color: var(--bg-container); border-radius: var(--radius-box); box-shadow: var(--shadow-soft); border-bottom: 6px solid #FF0055; }
        .container-box { width: 90%; max-width: 400px; padding: 20px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2; overflow: hidden; }
        .home-container { width: 90%; max-width: 650px; height: 70vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; z-index: 2; overflow: hidden; }
        .home-logo-img { width: 60%; max-width: 400px; height: auto; max-height: 50vh; object-fit: contain; margin-bottom: 30px; animation: pulseLogo 3s ease-in-out infinite; }
        .home-btn-wrapper { width: 60%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }

        .game-screen-layout { width: 80%; max-width: 1000px; height: 95%; display: flex; flex-direction: column; justify-content: space-between; z-index: 2; }
        .game-header { width: 100%; height: 15%; min-height: 80px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-bottom: 15px; overflow: visible; z-index: 100; position: relative; }
        .header-left-group { display: flex; align-items: center; gap: 15px; height: 100%; overflow: hidden; }
        .header-left-group img { height: 70%; width: auto; max-width: 100%; object-fit: contain; }
        .gh-right { position: relative; }

        .game-body { width: 100%; height: 82%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 10; overflow: hidden; }

        .tut-title-in-body { color: var(--primary); margin: 50px 0 10px 0; font-size: 1.8rem; text-transform: uppercase; position: relative; z-index: 5; }
        .instruction-text { margin-top: -10px; margin-bottom: 10px; color: #aaa; font-size: 0.9rem; position: relative; z-index: 2; }

        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .screen.active { display: flex; }
        .hidden { display: none !important; }

        .btn { background: var(--primary); color: white; border: none; padding: 12px 0; margin: 8px 0; width: 100%; font-size: 1.2rem; border-radius: 50px; cursor: pointer; font-family: 'Fredoka One'; transition: transform 0.1s; box-shadow: 0 4px 0 #4a80b8; }
        .btn:active { transform: scale(0.98); box-shadow: 0 2px 0 #4a80b8; }
        .btn-green { background: var(--success); box-shadow: 0 4px 0 #4e9632; } .btn-green:active { box-shadow: 0 2px 0 #4e9632; }
        .btn-red { background: var(--danger); box-shadow: 0 4px 0 #b83b45; }
        .btn-orange { background: var(--warning); box-shadow: 0 4px 0 #c66900; } .btn-orange:active { box-shadow: 0 2px 0 #c66900; }

        .btn-icon { width: auto; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: none; background: #eee; color: #555; border: none; cursor: pointer; transition: all 0.2s ease; }
        .btn-icon:hover { transform: scale(1.15); background-color: #e0e0e0; color: var(--primary); }

        input[type="text"] { padding: 12px; border-radius: 30px; border: 3px solid var(--primary); background: var(--bg-app); font-family: 'Fredoka One'; font-size: 1.1rem; text-align: center; width: 100%; margin-bottom: 15px; outline: none; color: #555; }

        #game-cards-wrapper, #tut-cards-wrapper { position: relative; width: var(--card-width); height: var(--card-height); perspective: 1000px; z-index: 5; }
        .card { position: absolute; width: 100%; height: 100%; background: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; border: 4px solid white; touch-action: none; cursor: grab; }
        .card img, .card video { width: 100%; height: 75%; object-fit: cover; pointer-events: none; background: #eee; }
        .card-text { height: 25%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; background: #fff; color: #444; padding: 5px; line-height: 1.1; text-align: center; }

        .indicator-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; display: flex; align-items: center; justify-content: center; }
        .ind-zone { flex: 1; display: flex; justify-content: center; align-items: center; height: 100%; }
        .ind-spacer { width: var(--card-width); flex-shrink: 0; }
        .ind-box { opacity: 0.3; transition: 0.2s; display: flex; flex-direction: column; align-items: center; }
        .ind-box span { font-size: 6rem; filter: drop-shadow(2px 2px 0px white); } 
        .ind-box div { font-size: 2.2rem; font-weight: 900; text-shadow: 2px 2px 0 #fff; letter-spacing: 1px; }
        .ind-left { color: var(--danger); } .ind-right { color: var(--success); }

        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: flex; justify-content: center; align-items: center; pointer-events: none; opacity: 0; transition: opacity 0.3s; background: rgba(0,0,0,0.2); }
        .feedback-card-style { background: white; width: var(--card-width); height: var(--card-height); border-radius: 20px; padding: 20px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; transform: translateY(-50px) scale(0.9); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.show { opacity: 1; pointer-events: auto; } .modal-overlay.show .feedback-card-style { transform: translateY(0) scale(1); }
        .fb-img { width: 100px; height: 100px; object-fit: contain; margin-bottom: 15px; }
        .fb-text { font-size: 1.8rem; margin-bottom: 10px; font-weight: bold; }
        .border-safe { border: 6px solid var(--success); } .border-unsafe { border: 6px solid var(--danger); } .border-alert { border: 6px solid #FF9800; } 

        #generic-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9000; display: flex; justify-content: center; align-items: center; visibility: hidden; opacity: 0; transition: 0.3s; }
        #generic-card { background: white; width: 80%; max-width: 300px; border-radius: 25px; padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #generic-modal.show { visibility: visible; opacity: 1; } #generic-modal.show #generic-card { transform: scale(1); }
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }

        /* RESULT PAGE */
        #result-img { width: 150px; height: auto; margin-bottom: 15px; }
        #result-title { font-size: 1.6rem; margin-bottom: 10px; line-height: 1.3; color: var(--primary); padding: 0 10px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #result-score-text { font-size: 1.2rem; color: #666; margin-bottom: 20px; }

        /* COUNTDOWN OVERLAY */
        #countdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 3000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .count-number {
            font-size: 12rem; font-weight: 900;
            opacity: 0; 
            text-shadow: 5px 5px 0px rgba(0,0,0,0.1);
        }
        .count-red { color: var(--danger); }
        .count-yellow { color: var(--warning); }
        .count-green { color: var(--success); }
        
    </style>
</head>
<body>

    <div id="background-layer"></div>
    <audio id="audio-player"></audio>

    <div id="tut-guide-overlay"></div>
    <div id="tut-hand">ðŸ‘†</div>

    <div id="screen-home" class="screen active">
        <div class="home-container pop-in">
            <img src="img src/logokuis.png" class="home-logo-img" alt="Logo Kuis" onclick="speak('Kuis Perilaku Anak Hebat')">
            <div class="home-btn-wrapper">
                <button class="btn" onclick="startTutorial()">TUTORIAL</button>
                <button class="btn btn-green" onclick="goToNameInput()">MULAI MAIN</button>
            </div>
        </div>
    </div>

    <div id="screen-tutorial" class="screen">
        <div class="game-screen-layout">
            <div class="game-header pop-in">
                <div class="header-left-group">
                    <img src="img src/logoautis.png" alt="Logo Autis" onerror="this.src='https://placehold.co/100x100?text=L1'">
                    <img src="img src/logokuis.png" alt="Logo Kuis" onerror="this.src='https://placehold.co/150x80?text=L2'">
                </div>
                <div class="gh-right">
                    <button class="btn-icon" id="tut-home-btn" onclick="handleHomeClick()"><span class="material-icons-round">home</span></button>
                </div>
            </div>

            <div class="game-body pop-in delay-1" id="tut-body">
                <div id="tut-hand">ðŸ‘†</div> 
                <h2 class="tut-title-in-body">TUTORIAL</h2>
                <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative;">
                    <div id="tut-cards-wrapper"></div>
                    <div class="indicator-overlay" id="tut-indicator">
                        <div class="ind-zone zone-left"><div class="ind-box ind-left"><span class="material-icons-round">thumb_down</span><div>JANGAN</div></div></div>
                        <div class="ind-spacer"></div>
                        <div class="ind-zone zone-right"><div class="ind-box ind-right"><span class="material-icons-round">thumb_up</span><div>BOLEH</div></div></div>
                    </div>
                </div>
                <div class="instruction-text">Geser kartu ke arah yang benar</div>
            </div>
        </div>
        
        <div id="tut-feedback-modal" class="modal-overlay">
             <div id="tut-feedback-card" class="feedback-card-style">
                <img id="tut-feedback-img" class="fb-img" src="" alt="icon">
                <div id="tut-feedback-text" class="fb-text"></div>
                <div id="tut-feedback-detail" class="fb-detail"></div>
                <div id="tut-end-buttons" class="hidden" style="width: 100%; display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-orange" onclick="retryTutorial()">ULANGI</button>
                    <button class="btn btn-green" onclick="finishTutorial()">MULAI</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-game-intro" class="screen">
        <div class="container-box pop-in">
            <img src="img src/logokuis.png" alt="Logo Kuis" style="width: 120px; max-width: 100%; margin-bottom: 15px;" onerror="this.src='https://placehold.co/300x150?text=LOGO+KUIS'">
            <h3 style="margin: 10px 0; color: #555;">Siapa Namamu?</h3>
            <input type="text" id="input-name" placeholder="Tulis Namamu..." autocomplete="off">
            <button class="btn btn-green" onclick="validateAndStartGame()">MULAI MAIN</button>
        </div>
    </div>

    <div id="countdown-overlay">
        <div id="countdown-number" class="count-number"></div>
    </div>

    <div id="screen-game-play" class="screen">
        <div class="game-screen-layout">
            <div class="game-header pop-in">
                <div class="header-left-group">
                    <img src="img src/logoautis.png" alt="Logo Autis" onerror="this.src='https://placehold.co/100x100?text=L1'">
                    <img src="img src/logokuis.png" alt="Logo Kuis" onerror="this.src='https://placehold.co/150x80?text=L2'">
                </div>
                <div class="gh-right">
                    <button class="btn-icon" onclick="handleHomeClick()"><span class="material-icons-round">home</span></button>
                </div>
            </div>
            <div class="game-body pop-in delay-1" id="game-body-id">
                <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative;">
                    <div id="game-cards-wrapper"></div>
                    <div class="indicator-overlay" id="main-indicator">
                        <div class="ind-zone zone-left"><div class="ind-box ind-left"><span class="material-icons-round">thumb_down</span><div>JANGAN</div></div></div>
                        <div class="ind-spacer"></div>
                        <div class="ind-zone zone-right"><div class="ind-box ind-right"><span class="material-icons-round">thumb_up</span><div>BOLEH</div></div></div>
                    </div>
                </div>
                <div class="instruction-text">Geser kartu ke arah yang benar</div>
            </div>
        </div>
        <div id="game-feedback-modal" class="modal-overlay">
            <div id="game-feedback-card" class="feedback-card-style">
                <img id="game-feedback-img" class="fb-img" src="" alt="Feedback">
                <div id="game-feedback-text" class="fb-text"></div>
                <div id="game-feedback-detail" class="fb-detail"></div>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="container-box pop-in" style="max-width: 500px;">
            <h2 id="result-title">HASIL</h2>
            <img id="result-img" src="" alt="Hasil" onerror="this.src='https://placehold.co/200x200?text=RESULT'">
            <div id="result-score-text">Skor: 0</div>
            <div id="result-actions" style="width: 100%; display: flex; flex-direction: column; gap: 10px;"></div>
        </div>
    </div>

    <div id="generic-modal">
        <div id="generic-card">
            <h2 id="modal-title" style="color:var(--primary); margin-top:0;">Judul</h2>
            <p id="modal-msg" style="font-size: 1rem; color:#555;">Pesan</p>
            <div id="action-quit" class="modal-actions hidden">
                <button class="btn btn-green" style="width: auto; padding: 8px 25px;" onclick="handleModalAction(true)">YA</button>
                <button class="btn btn-red" style="width: auto; padding: 8px 25px;" onclick="handleModalAction(false)">TIDAK</button>
            </div>
            <div id="action-alert" class="modal-actions hidden">
                <button class="btn" style="width: auto; padding: 8px 30px;" onclick="closeGenericModal()">OKE</button>
            </div>
        </div>
    </div>

    <script>
        const emojis = ['ðŸ“–', 'âœ', 'ðŸ–', 'ðŸ“', 'ðŸ“', 'ðŸ–Š'];
        const layer = document.getElementById('background-layer');

        function spawnFloater() {
            const el = document.createElement('div');
            el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            el.classList.add('floating-emoji');
            const size = 30 + Math.random() * 40; 
            const startSide = Math.floor(Math.random() * 4); 
            el.style.fontSize = `${size}px`;
            el.style.opacity = (0.15 + Math.random() * 0.15).toString(); 
            let startX, startY, endX, endY;
            const w = window.innerWidth; const h = window.innerHeight; const offset = 100; 
            if (startSide === 0) { startX = -offset; startY = Math.random() * h; endX = w + offset; endY = Math.random() * h; } 
            else if (startSide === 1) { startX = w + offset; startY = Math.random() * h; endX = -offset; endY = Math.random() * h; } 
            else if (startSide === 2) { startX = Math.random() * w; startY = -offset; endX = Math.random() * w; endY = h + offset; } 
            else { startX = Math.random() * w; startY = h + offset; endX = Math.random() * w; endY = -offset; }
            el.style.left = `${startX}px`; el.style.top = `${startY}px`;
            layer.appendChild(el);
            const duration = 10000 + Math.random() * 5000; const rotateDir = Math.random() > 0.5 ? 360 : -360; 
            const animation = el.animate([ { transform: `translate(0, 0) rotate(0deg)` }, { transform: `translate(${endX - startX}px, ${endY - startY}px) rotate(${rotateDir}deg)` } ], { duration: duration, easing: 'linear', fill: 'forwards' });
            animation.onfinish = () => el.remove();
        }
        setTimeout(() => { setInterval(spawnFloater, 1500); }, 2500);

        const audioPlayer = document.getElementById('audio-player');
        let audioCtx = null; 

        function speak(text, callback) {
            window.speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';
            utterance.rate = 0.9; 
            
            if (callback) {
                let hasCalledBack = false;
                const done = () => {
                    if (!hasCalledBack && callback) { hasCalledBack = true; callback(); }
                };
                utterance.onend = done;
                utterance.onerror = done; 
                setTimeout(done, 4000); 
            } else {
                utterance.onend = null;
            }
            
            window.speechSynthesis.speak(utterance);
        }

        function playTone(type) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(1000, now); osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1); gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6); osc.start(now); osc.stop(now + 0.6);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3); gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.4); osc.start(now); osc.stop(now + 0.4);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }, { once: true });
            setTimeout(() => { speak("Kuis Perilaku Anak Hebat"); }, 1000);
        });

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const newScreen = document.getElementById(screenId);
            newScreen.classList.add('active');
            document.body.style.animation = 'colorCycle 40s linear infinite';
            document.body.style.backgroundColor = ''; 
            const popElements = newScreen.querySelectorAll('.pop-in');
            popElements.forEach(el => { 
                el.style.animation = 'none'; el.offsetHeight; 
                el.style.animation = 'popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, borderFlow 5s linear infinite';
            });
        }

        // --- DATA ---
        const tutorialQuestions = [ 
            { type: 'image', img: "salaman.jpg", text: "Bersalaman dengan teman", isSafe: true, msg: "Bersalaman dengan teman biar akrab." }, 
            { type: 'image', img: "memukul.jpg", text: "Memukul", isSafe: false, msg: "Benar! Ini Tidak Boleh." } 
        ];
        
        const mainQuestions = [ 
            { type: 'image', img: "salaman.jpg", text: "Bersalaman dengan teman", isSafe: true, msg: "Bersalaman dengan teman biar akrab." }, 
            { type: 'image', img: "menjambak.jpg", text: "Menjambak teman", isSafe: false, msg: "Sakit! Tidak boleh menjambak." }, 
            { type: 'image', img: "pelukan.jpg", text: "Dipeluk Ibu", isSafe: true, msg: "Pelukan ibu tanda sayang." }, 
            { type: 'image', img: "tos.jpg", text: "Tos dengan teman", isSafe: true, msg: "Tos tanda kompak." }, 
            { type: 'image', img: "memukul.jpg", text: "Memukul teman", isSafe: false, msg: "Memukul itu menyakiti teman." }, 
            { type: 'image', img: "rahasia.jpg", text: "Menyentuh tubuh teman bagian di dalam baju", isSafe: false, msg: "Itu area privasi, tidak boleh." }, 
            { type: 'image', img: "dokter.jpg", text: "Diperiksa Dokter", isSafe: true, msg: "Dokter membantu kita sehat." }, 
            { type: 'image', img: "asing.jpg", text: "Didekati Orang Asing", isSafe: false, msg: "Berbahaya, segera menjauh" }, 
            { type: 'image', img: "mandi.jpg", text: "Mandi dengan ibu atau ayah", isSafe: true, msg: "Mandi badan jadi bersih." }, 
            { type: 'image', img: "dorong.jpg", text: "Bermain-main mendorong Teman", isSafe: false, msg: "Teman bisa jatuh sakit." }, 
            { type: 'image', img: "teriak.jpg", text: "Teriak-teriak", isSafe: false, msg: "Jangan teriak, itu mengganggu orang lain." }, 
            { type: 'image', img: "tantrum.jpg", text: "Menangis berguling-guling", isSafe: false, msg: "Nanti baju jadi kotor dan mengganggu orang lain" }, 
            { type: 'image', img: "cuek.jpg", text: "Cuek saat dipanggil", isSafe: false, msg: "Harus menjawab kalau dipanggil." },
            { type: 'image', img: "antri.jpg", text: "Menyerobot Antrian", isSafe: false, msg: "Harus sabar mengantri." },
            { type: 'image', img: "angkat.jpg", text: "Angkat Tangan saat di Kelas", isSafe: true, msg: "Bicara bergantian itu sopan." },
            { type: 'image', img: "rebut.jpg", text: "Merebut Mainan Teman", isSafe: false, msg: "Harus izin dulu kalau meminjam." },
            { type: 'image', img: "lari.jpg", text: "Lari-lari di dalam Kelas", isSafe: false, msg: "Saat belajar harus duduk tenang." }
        ];
        
        let tutIndex = 0; let gameIndex = 0; let score = 0; let playerName = "";
        
        function startTutorial() {
            tutIndex = 0;
            document.getElementById('tut-home-btn').classList.remove('highlight-focus');
            const arr = document.getElementById('tut-helper-arrow'); if(arr) arr.remove();
            document.getElementById('tut-end-buttons').classList.add('hidden');
            
            showScreen('screen-tutorial');
            
            speak("Tutorial dimulai");
            showGenericModal('alert', 'Tutorial', 'Tutorial Dimulai!', function() {
                const q = tutorialQuestions[tutIndex];
                speak(q.text, function() {
                     const bodyBox = document.getElementById('tut-body');
                     const wrapper = document.getElementById('tut-cards-wrapper');
                     
                     bodyBox.classList.add('allow-overflow'); 
                     wrapper.classList.add('highlight-card');

                     setTimeout(() => { showTutorialHand(q.isSafe); }, 500);
                });
                initGameEngine('tut-cards-wrapper', tutorialQuestions.slice(tutIndex), onTutorialResult);
            });
        }

        function showTutorialHand(isRight) {
            const hand = document.getElementById('tut-hand');
            hand.style.display = 'block';
            speak(isRight ? "Geser kartu ke kanan!" : "Geser kartu ke kiri!");
            hand.style.animation = isRight ? 'swipeRightAnim 1.5s ease-in-out infinite' : 'swipeLeftAnim 1.5s ease-in-out infinite';
            const removeHand = () => {
                hand.style.display = 'none';
                document.getElementById('tut-cards-wrapper').classList.remove('highlight-card');
                document.getElementById('tut-body').classList.remove('allow-overflow');
                document.removeEventListener('touchstart', removeHand);
                document.removeEventListener('mousedown', removeHand);
            };
            document.addEventListener('touchstart', removeHand);
            document.addEventListener('mousedown', removeHand);
        }

        function retryTutorial() {
            document.getElementById('tut-feedback-modal').classList.remove('show');
            startTutorial();
        }

        function onTutorialResult(isCorrect, qData) {
            const modal = document.getElementById('tut-feedback-modal'); const card = document.getElementById('tut-feedback-card'); const img = document.getElementById('tut-feedback-img'); const txt = document.getElementById('tut-feedback-text'); const det = document.getElementById('tut-feedback-detail');
            
            playTone(isCorrect ? 'correct' : 'wrong');
            const msg = (isCorrect ? "Benar. " : "Salah. ") + qData.msg;
            
            if (isCorrect) { 
                card.className = 'feedback-card-style border-safe'; img.src = encodeURI('img src/benar.png'); txt.innerText = "HEBAT!"; txt.style.color = "var(--success)"; det.innerText = qData.msg; modal.classList.add('show');
            } else { 
                card.className = 'feedback-card-style border-unsafe'; img.src = encodeURI('img src/salah.png'); txt.innerText = "OOPS!"; txt.style.color = "var(--danger)"; det.innerText = "Jawabanmu kurang tepat. Coba lagi ya!"; modal.classList.add('show');
            }

            speak(msg, function() {
                 if (isCorrect) {
                    if (tutIndex < tutorialQuestions.length - 1) { 
                        tutIndex++; 
                        modal.classList.remove('show'); 
                        const q = tutorialQuestions[tutIndex];
                        speak(q.text, function() {
                            initGameEngine('tut-cards-wrapper', tutorialQuestions.slice(tutIndex), onTutorialResult); 
                            const bodyBox = document.getElementById('tut-body');
                            bodyBox.classList.add('allow-overflow');
                            document.getElementById('tut-cards-wrapper').classList.add('highlight-card');
                            setTimeout(() => showTutorialHand(q.isSafe), 500);
                        });
                    } else {
                         modal.classList.remove('show'); 
                         explainHomeButton();
                    }
                } else {
                    modal.classList.remove('show'); 
                    const q = tutorialQuestions[tutIndex];
                    speak(q.text, function() {
                        initGameEngine('tut-cards-wrapper', tutorialQuestions.slice(tutIndex), onTutorialResult);
                        const bodyBox = document.getElementById('tut-body');
                        bodyBox.classList.add('allow-overflow');
                        document.getElementById('tut-cards-wrapper').classList.add('highlight-card');
                        setTimeout(() => showTutorialHand(q.isSafe), 500);
                    });
                }
            });
        }

        function explainHomeButton() {
            const homeBtn = document.getElementById('tut-home-btn');
            const homeBtnContainer = homeBtn.parentElement;
            const arrow = document.createElement('span');
            arrow.className = 'material-icons-round tutorial-arrow';
            arrow.innerText = 'arrow_upward';
            arrow.id = 'tut-helper-arrow';
            homeBtnContainer.appendChild(arrow);
            homeBtn.classList.add('highlight-focus');
            
            // PARALEL: SUARA & POPUP
            speak("Ini tombol kembali ke beranda");
            showGenericModal('alert', 'Tombol Rumah', 'Tekan tombol rumah di atas untuk kembali ke menu awal.', function() {
                homeBtn.classList.remove('highlight-focus');
                const arrowToDelete = document.getElementById('tut-helper-arrow');
                if(arrowToDelete) arrowToDelete.remove();

                const modal = document.getElementById('tut-feedback-modal');
                const card = document.getElementById('tut-feedback-card');
                const img = document.getElementById('tut-feedback-img');
                const txt = document.getElementById('tut-feedback-text');
                const det = document.getElementById('tut-feedback-detail');
                const endBtns = document.getElementById('tut-end-buttons');
                
                card.className = 'feedback-card-style border-safe';
                img.src = encodeURI('img src/benar.png');
                txt.innerText = "SIAP!";
                det.innerText = "Kamu sudah paham.";
                endBtns.classList.remove('hidden'); 
                modal.classList.add('show');
            });
        }

        function goToNameInput() {
            showScreen('screen-game-intro');
            speak("Siapa namamu?");
        }

        function finishTutorial() { document.getElementById('tut-feedback-modal').classList.remove('show'); goToNameInput(); }

        function validateAndStartGame() {
            const input = document.getElementById('input-name');
            if (input.value.trim() === "") {
                showGenericModal('alert', 'Nama Kosong', 'Isi nama dulu ya!');
                return;
            }
            playerName = input.value.trim();
            input.value = "";
            
            // PARALEL: SUARA + COUNTDOWN
            speak("Ayo kita mulai main, " + playerName);
            startCountdown(() => {
                startGamePlay();
            });
        }

        function startCountdown(callback) {
            const overlay = document.getElementById('countdown-overlay');
            const numEl = document.getElementById('countdown-number');
            overlay.style.display = 'flex';
            
            const showNum = (n, color) => {
                numEl.innerText = n;
                numEl.className = 'count-number ' + color;
                numEl.style.animation = 'none';
                numEl.offsetHeight; 
                numEl.style.animation = 'countPop 1s ease forwards';
            };

            showNum('3', 'count-red');
            setTimeout(() => {
                showNum('2', 'count-yellow');
                setTimeout(() => {
                    showNum('1', 'count-green');
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        callback();
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        function startGamePlay() { 
            gameIndex = 0; 
            score = 0; 
            showScreen('screen-game-play'); 
            initGameEngine('game-cards-wrapper', mainQuestions, onGameResult); 
            speak(mainQuestions[0].text);
        }

        function onGameResult(isCorrect, qData) {
            if(isCorrect) score++;
            gameIndex++; 
            
            playTone(isCorrect ? 'correct' : 'wrong');
            const msg = (isCorrect ? "Benar. " : "Salah. ") + qData.msg;
            
            const modal = document.getElementById('game-feedback-modal'); const card = document.getElementById('game-feedback-card'); const img = document.getElementById('game-feedback-img'); const txt = document.getElementById('game-feedback-text'); const det = document.getElementById('game-feedback-detail');
            card.className = isCorrect ? 'feedback-card-style border-safe' : 'feedback-card-style border-unsafe'; img.src = encodeURI('img src/benar.png'); txt.innerText = isCorrect ? "BENAR!" : "SALAH!"; txt.style.color = isCorrect ? 'var(--success)' : 'var(--danger)'; det.innerText = qData.msg; modal.classList.add('show');
            
            speak(msg, function() {
                 modal.classList.remove('show'); 
                 if (gameIndex < mainQuestions.length) { 
                     const nextQ = mainQuestions[gameIndex];
                     initGameEngine('game-cards-wrapper', mainQuestions.slice(gameIndex), onGameResult); 
                     speak(nextQ.text);
                 } else { 
                     showResultPage();
                 } 
            });
        }

        function showResultPage() {
            showScreen('screen-result');
            const total = mainQuestions.length;
            const title = document.getElementById('result-title');
            const img = document.getElementById('result-img');
            const scoreTxt = document.getElementById('result-score-text');
            const btnContainer = document.getElementById('result-actions');
            
            const isPass = score > (total / 2);
            scoreTxt.innerText = `Skor Kamu: ${score} / ${total}`;
            btnContainer.innerHTML = ''; 

            if (isPass) {
                title.innerText = `Hore! Selamat kamu berhasil, ${playerName}!`;
                title.style.color = "var(--success)";
                img.src = "img src/menang.png";
                speak(`Selamat kamu berhasil, ${playerName}!`);
                
                if (score === total) {
                    btnContainer.innerHTML = `<button class="btn" onclick="showScreen('screen-home')">KEMBALI KE BERANDA</button>`;
                } else {
                    btnContainer.innerHTML = `
                        <button class="btn btn-green" onclick="startGamePlay()">MAIN LAGI</button>
                        <button class="btn" onclick="showScreen('screen-home')">KEMBALI KE BERANDA</button>
                    `;
                }
            } else {
                title.innerText = `Yah, ayo kita mulai ulang lagi, ${playerName}`;
                title.style.color = "var(--warning)";
                img.src = "img src/lagi.gif";
                speak(`Yah, ayo kita coba lagi, ${playerName}`);
                
                btnContainer.innerHTML = `
                    <button class="btn btn-green" onclick="startGamePlay()">MAIN LAGI</button>
                    <button class="btn" onclick="startTutorial()">KEMBALI KE TUTORIAL</button>
                `;
            }
            const container = document.querySelector('#screen-result .container-box');
            setTimeout(() => { fitTextToContainer(title, container.clientWidth - 40); }, 50);
        }

        function fitTextToContainer(element, containerWidth) { let fontSize = 2.5; element.style.fontSize = fontSize + 'rem'; element.style.whiteSpace = 'nowrap'; while (element.scrollWidth > containerWidth && fontSize > 0.8) { fontSize -= 0.1; element.style.fontSize = fontSize + 'rem'; } }

        function handleHomeClick() {
            speak("Mau kembali ke beranda?");
            showGenericModal('quit');
        }

        function showGenericModal(type, title, msg, callback) {
            const modal = document.getElementById('generic-modal'); const card = document.getElementById('generic-card'); document.getElementById('action-quit').classList.add('hidden'); document.getElementById('action-alert').classList.add('hidden');
            
            if (type === 'quit') { 
                document.getElementById('modal-title').innerText = "Kembali ke Beranda?"; 
                document.getElementById('modal-msg').innerText = "Permainan akan dihentikan."; 
                document.getElementById('action-quit').classList.remove('hidden'); 
            } else if (type === 'alert') { 
                document.getElementById('modal-title').innerText = title || "Info"; 
                document.getElementById('modal-msg').innerText = msg || ""; 
                const alertActions = document.getElementById('action-alert');
                alertActions.classList.remove('hidden');
                card.className = "feedback-card-style border-alert"; card.style.height = "auto"; card.style.minHeight = "150px";
                
                const btn = alertActions.querySelector('.btn');
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.onclick = function() {
                    closeGenericModal();
                    if(callback) callback(); 
                };
            }
            modal.classList.add('show');
        }
        
        function closeGenericModal() { document.getElementById('generic-modal').classList.remove('show'); } 
        function handleModalAction(isYes) { closeGenericModal(); if (isYes) showScreen('screen-home'); }
        
        let isDragging = false, startX = 0, currentCard = null, activeWrapperId = '', activeCallback = null;
        
        function initGameEngine(wrapperId, dataSet, resultCallback) {
            const wrapper = document.getElementById(wrapperId); wrapper.innerHTML = '';
            dataSet.slice().reverse().forEach((q, i) => { 
                const card = document.createElement('div'); 
                card.className = 'card'; 
                
                card.dataset.isSafe = q.isSafe; 
                card.dataset.msg = q.msg;

                const stackIndex = dataSet.length - 1 - i; 
                card.style.zIndex = 100 - stackIndex; 
                if(stackIndex > 0) card.style.transform = 'scale(0.95) translateY(10px)'; 
                
                const safePath = encodeURI(`img src/${q.img}`);
                let contentHtml = '';
                if(q.type === 'video') {
                    contentHtml = `<video src="${safePath}" autoplay loop muted playsinline style="width:100%; height:75%; object-fit:cover; background:#000;"></video>`;
                } else {
                    contentHtml = `<img src="${safePath}" onerror="this.parentNode.style.backgroundColor='#eee'; this.src='https://placehold.co/280x300?text=Img';">`;
                }
                card.innerHTML = `${contentHtml}<div class="card-text"><b>${q.text}</b></div>`; 
                wrapper.appendChild(card); 
            });
            if (wrapper.lastElementChild) { 
                setupDragForTopCard(wrapper.lastElementChild, wrapperId, resultCallback); 
            }
        }
        function setupDragForTopCard(cardElement, wrapperId, callback) { currentCard = cardElement; activeWrapperId = wrapperId; activeCallback = callback; currentCard.style.transition = 'transform 0.3s ease'; currentCard.style.transform = 'translate(0, 0) rotate(0)'; currentCard.onmousedown = startDrag; currentCard.ontouchstart = (e) => startDrag(e.touches[0]); }
        function startDrag(e) { isDragging = true; startX = e.clientX; currentCard.style.transition = 'none'; document.addEventListener('mousemove', onDragMove); document.addEventListener('mouseup', onDragEnd); document.addEventListener('touchmove', onTouchMove, {passive: false}); document.addEventListener('touchend', onDragEnd); document.body.style.animation = 'none'; }
        function onTouchMove(e) { e.preventDefault(); onDragMove(e.touches[0]); }
        function onDragMove(e) {
            if (!isDragging || !currentCard) return;
            const deltaX = e.clientX - startX; const rotate = deltaX * 0.05;
            currentCard.style.transform = `translate(${deltaX}px, 0) rotate(${rotate}deg)`;
            const indId = activeWrapperId === 'tut-cards-wrapper' ? 'tut-indicator' : 'main-indicator';
            const indLeft = document.querySelector(`#${indId} .ind-left`); const indRight = document.querySelector(`#${indId} .ind-right`);
            const intensity = Math.min(Math.abs(deltaX) / 100, 0.9); 
            if (deltaX > 0) { indRight.style.opacity = 1; indRight.style.transform = 'scale(1.2)'; document.body.style.backgroundColor = `rgba(106, 196, 69, ${intensity})`; }
            else if (deltaX < 0) { indLeft.style.opacity = 1; indLeft.style.transform = 'scale(1.2)'; document.body.style.backgroundColor = `rgba(255, 82, 95, ${intensity})`; }
            else { indRight.style.opacity = 0.3; indRight.style.transform = 'scale(1)'; indLeft.style.opacity = 0.3; indLeft.style.transform = 'scale(1)'; document.body.style.backgroundColor = ''; }
        }
        function onDragEnd(e) {
            if (!isDragging) return; isDragging = false;
            document.removeEventListener('mousemove', onDragMove); document.removeEventListener('mouseup', onDragEnd); document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onDragEnd);
            const matrix = new WebKitCSSMatrix(window.getComputedStyle(currentCard).transform); const deltaX = matrix.m41; const threshold = 80;
            const indId = activeWrapperId === 'tut-cards-wrapper' ? 'tut-indicator' : 'main-indicator';
            document.querySelector(`#${indId} .ind-left`).style.opacity = 0.3; document.querySelector(`#${indId} .ind-left`).style.transform = 'scale(1)'; document.querySelector(`#${indId} .ind-right`).style.opacity = 0.3; document.querySelector(`#${indId} .ind-right`).style.transform = 'scale(1)';
            document.body.style.backgroundColor = '';
            document.body.style.animation = 'colorCycle 40s linear infinite';
            if (deltaX > threshold) { processSwipe(true); } else if (deltaX < -threshold) { processSwipe(false); } else { currentCard.style.transition = 'transform 0.3s ease'; currentCard.style.transform = 'translate(0, 0) rotate(0)'; }
        }
        function processSwipe(isSwipeRight) {
            const flyX = isSwipeRight ? 1000 : -1000;
            currentCard.style.transition = 'transform 0.5s ease';
            currentCard.style.transform = `translate(${flyX}px, 50px) rotate(${flyX/15}deg)`;
            
            const cardIsSafe = (currentCard.dataset.isSafe === 'true'); 
            const userGuessedSafe = isSwipeRight; 
            const isCorrect = (cardIsSafe === userGuessedSafe);
            
            const msgFromData = currentCard.dataset.msg;
            const qData = { msg: msgFromData }; 
            
            setTimeout(() => { if(activeCallback) activeCallback(isCorrect, qData); }, 300);
        }
    </script>
</body>
</html>

